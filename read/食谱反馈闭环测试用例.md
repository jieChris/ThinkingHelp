# 食谱反馈闭环测试用例

## 0. 追踪信息
- 关联任务编号：`B1`、`B2`、`B4`
- 关联变更编号：`TH-2026-02-012`、`TH-2026-02-013`、`TH-2026-02-014`
- 关联任务文档：`read/功能任务清单.md`
- 关联变更文档：`read/项目变更日志.md`

## 1. 目的与范围
验证“食谱反馈闭环优化”能力是否生效，重点覆盖：
- 餐次反馈记录（不够吃/太多了）
- 生成食谱时反馈注入
- 食谱页面“本次按反馈已调整”展示
- PDF 导出中的调整说明
- 生成前反馈影响预览（下一步新增）

## 2. 前置条件
1. 后端服务已启动。
2. 前端服务已启动。
3. 用户已登录，且可访问“食谱中心”。
4. 已存在可用 AI 配置（MEAL_PLAN key 可用）。

## 3. 关键接口
- `POST /api/meal-plan/feedback`
- `GET /api/meal-plan/generate` 或 `POST /api/meal-plan/generate-async`
- `GET /api/export/pdf`
- `GET /api/meal-plan/feedback/summary`（新增预览接口）

## 4. 测试数据建议
建议先连续点击反馈：
- 早餐：`MORE` 2 次
- 午餐：`LESS` 2 次
- 晚餐：`MORE` 1 次

## 5. 测试用例

### A. 反馈记录
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| MPF-001 | 记录“吃不饱”反馈 | 在食谱页点击早餐“不够吃” | 接口返回成功，提示“已记录反馈” |
| MPF-002 | 记录“太多了”反馈 | 点击午餐“太多了” | 接口返回成功，提示“已记录反馈” |
| MPF-003 | 参数非法拦截 | 构造非法 mealType/direction 调接口 | 返回“反馈参数无效” |

### B. 生成前预览
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| MPF-101 | 预览可见 | 打开食谱页生成区 | 显示“下次生成预计调整”卡片（有反馈时） |
| MPF-102 | 无反馈提示 | 新账号未反馈 | 显示“暂无历史反馈调整项”或不显示卡片 |
| MPF-103 | 预览刷新 | 连续提交反馈后刷新页面 | 预览项随反馈变化 |

### C. 生成后调整说明
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| MPF-201 | 页面展示调整说明 | 反馈后生成食谱 | 页面显示“本次食谱已根据你的反馈做了调整” |
| MPF-202 | 早餐上调说明 | 早餐 MORE 明显多于 LESS | 出现“早餐份量上调约X%” |
| MPF-203 | 午餐下调说明 | 午餐 LESS 明显多于 MORE | 出现“午餐份量下调约X%” |
| MPF-204 | 无显著偏向 | MORE 与 LESS 相同 | 不生成该餐次调整说明 |

### D. 导出与持久化
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| MPF-301 | PDF 含调整说明 | 生成后导出 PDF | PDF 中出现“本次按反馈已调整”及条目 |
| MPF-302 | 保存后再查看 | 保存食谱后打开详情 | 仍可看到 adjustmentNotes（若有） |
| MPF-303 | 列表摘要可见 | 在“已保存食谱”列表查看 | 有反馈的食谱显示“已调整 + 摘要”，无反馈显示“无” |
| MPF-304 | 列表筛选正确 | 切换“全部/仅已调整/仅未调整” | 表格仅显示对应类型的食谱，不混入其他类型 |
| MPF-305 | 时间筛选正确 | 切换“全部时间/本周/近30天” | 表格仅显示对应时间范围内食谱，可与调整筛选叠加生效 |
| MPF-306 | 关键词检索正确 | 输入标题或调整说明关键词 | 表格仅显示命中项，清空后恢复全部结果 |
| MPF-307 | 筛选状态持久化 | 设置筛选后刷新页面 | 筛选条件自动恢复，列表结果保持一致 |
| MPF-308 | URL 状态同步 | 设置筛选后观察地址栏并复制链接重新打开 | URL 包含筛选参数，重新打开后筛选状态与结果一致 |
| MPF-309 | 时间排序切换 | 切换“时间倒序/时间正序” | 列表顺序按创建时间正确变化 |
| MPF-310 | 分页可用 | 在列表较多时切换页码和每页数量 | 表格数据与分页器一致，切页不丢筛选条件 |
| MPF-311 | 重置筛选可用 | 设置多个筛选后点击“重置筛选” | 条件恢复默认值（全部/全部时间/空关键词/倒序/10条） |
| MPF-312 | 删除食谱可用 | 点击删除并确认 | 列表移除该项；若当前正在查看该食谱则预览区域清空并回到可生成状态 |
| MPF-313 | 后端分页查询生效 | 观察网络请求 `/api/meal-plan/page` 参数随筛选变化 | 后端返回 records/total 与前端筛选条件一致 |

### E. 回归与异常
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| MPF-401 | 不影响原生成流程 | 不提交任何反馈直接生成 | 正常生成，不报错 |
| MPF-402 | AI 失败回退 | 人为模拟 AI 不可用 | fallback 食谱仍可生成，流程不中断 |
| MPF-403 | 并发点击反馈 | 快速点击反馈按钮多次 | 系统不崩溃，按钮有 loading 防抖 |

## 6. 冒烟路径（最小）
1. 提交早餐 MORE、午餐 LESS 各 1 次。
2. 查看“生成前预览”。
3. 生成食谱并检查“调整说明”。
4. 导出 PDF 检查调整说明。

## 7. 结果记录模板
- 用例编号：
- 实际结果：
- 是否通过（Pass/Fail）：
- 备注（截图/接口返回）：
