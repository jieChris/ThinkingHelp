# 饮食记录增强测试用例

## 0. 追踪信息
- 关联任务编号：`A1`、`A2`、`A3`、`A4`、`A5`
- 关联变更编号：`TH-2026-02-007`、`TH-2026-02-008`、`TH-2026-02-009`、`TH-2026-02-010`、`TH-2026-02-011`
- 关联任务文档：`read/功能任务清单.md`
- 关联变更文档：`read/项目变更日志.md`

## 1. 目的与范围
验证饮食记录增强能力的关键链路：
- A1：自定义食物 + 自定义重量
- A2：记录持久化、同餐聚合、历史查看
- A3：热量计算（本地优先、AI兜底、缓存复用）
- A4：手动热量输入优先级
- A5：时间筛选与区间统计

## 2. 测试前准备
1. 确认后端已执行 `backend/patch_db.sql`，含 `diet_logs` 扩展字段与 `food_nutrition_cache` 表。
2. 启动前后端服务并使用普通用户登录。
3. 清理该测试账号当天饮食记录（可选，便于观察结果）。

## 3. 核心接口清单
- `POST /api/diet/log`
- `GET /api/diet/logs`
- `PUT /api/diet/log/{id}`
- `DELETE /api/diet/log/{id}`
- `POST /api/diet/estimate-calories`
- `POST /api/diet/estimate-macros`

## 4. 测试用例

### A1. 自定义食物 + 自定义重量
| 编号 | 关联任务 | 用例 | 步骤 | 预期结果 |
| --- | --- | --- | --- | --- |
| DIET-A1-001 | A1 | 下拉可输入自定义食物 | 在食物下拉中输入“手工荞麦面”并选中 | 可提交，不强制要求预设列表项 |
| DIET-A1-002 | A1 | 自定义重量录入 | 重量输入 `137g` 提交 | 记录保存成功，重量为 137g |
| DIET-A1-003 | A1 | 分量估算与自定义重量互斥 | 先选分量估算，再输入自定义重量 | 分量估算自动取消勾选 |

### A2. 持久化与历史查看
| 编号 | 关联任务 | 用例 | 步骤 | 预期结果 |
| --- | --- | --- | --- | --- |
| DIET-A2-001 | A2 | 记录入库与刷新回显 | 新增 2 条同餐记录后刷新页面 | 记录仍存在且可见 |
| DIET-A2-002 | A2 | 同餐聚合展示 | 同一日期同一餐次新增多条食物 | 历史列表按同餐聚合展示 |
| DIET-A2-003 | A2 | 编辑记录 | 修改一条记录的重量/热量 | 修改成功并实时反映在列表与统计 |
| DIET-A2-004 | A2 | 删除记录 | 删除一条记录 | 删除成功，统计同步扣减 |

### A3. 热量计算（本地 + AI + 缓存）
| 编号 | 关联任务 | 用例 | 步骤 | 预期结果 |
| --- | --- | --- | --- | --- |
| DIET-A3-001 | A3 | 本地食物热量计算 | 选择预设食物并输入重量 | 返回热量，来源标识为本地 |
| DIET-A3-002 | A3 | 非本地食物 AI 估算 | 输入“手工荞麦面”并估算热量 | 返回热量并显示“AI估算，仅供参考” |
| DIET-A3-003 | A3 | 缓存命中 | 对同一食物再次估算 | 响应更快，来源优先为缓存/本地 |
| DIET-A3-004 | A3 | AI 不可用降级 | 暂停 AI 服务后估算未知食物 | 页面不白屏，返回可理解错误提示 |

### A4. 手动热量优先
| 编号 | 关联任务 | 用例 | 步骤 | 预期结果 |
| --- | --- | --- | --- | --- |
| DIET-A4-001 | A4 | 手动热量覆盖自动估算 | 先自动估算，再手动输入热量 | 记录以手动热量为准 |
| DIET-A4-002 | A4 | 输入热量自动取消估算勾选 | 勾选分量估算后输入热量 | 分量估算自动取消 |
| DIET-A4-003 | A4 | 手动热量合法性校验 | 输入负数或非数字热量 | 阻止提交并提示输入错误 |

### A5. 时间筛选与区间统计
| 编号 | 关联任务 | 用例 | 步骤 | 预期结果 |
| --- | --- | --- | --- | --- |
| DIET-A5-001 | A5 | 预设筛选 | 切换 1天/3天/1周/1月/全部 | 列表和总热量按区间正确变化 |
| DIET-A5-002 | A5 | 自定义起止时间 | 选择开始和结束日期查询 | 仅返回区间内记录，边界正确包含 |
| DIET-A5-003 | A5 | 空区间 | 选择无数据时间段 | 列表为空且统计值为 0 |
| DIET-A5-004 | A5 | 跨日统计准确 | 跨天录入多餐后按区间统计 | 总热量等于区间内记录汇总值 |

## 5. 冒烟最小路径
1. 新增一条预设食物记录（100g）。
2. 新增一条自定义食物记录（含自定义重量）。
3. 对自定义食物执行一次 AI 估算并再次估算验证缓存。
4. 手动修改其中一条记录热量。
5. 切换时间筛选到“本周”并核对统计值。

## 6. 结果记录模板
- 用例编号：
- 执行时间：
- 实际结果：
- 是否通过：Pass/Fail
- 备注（截图/接口返回/日志）：
