# ThinkingHelp 商用上线正式使用手册

## 1. 文档信息
- 文档名称：ThinkingHelp 商用上线正式使用手册
- 适用版本：`thinking-help-system`（当前仓库版本）
- 适用环境：生产环境（阿里云或同等云环境）
- 目标读者：产品负责人、项目经理、后端工程师、前端工程师、测试工程师、运维工程师、安全与合规人员

## 2. 文档目的
本手册用于指导 ThinkingHelp 系统从开发态转为可商用运行态，提供可执行的标准流程，覆盖：
- 上线前准备
- 环境部署与配置
- 安全与合规基线
- 运维监控与应急
- 版本发布与回滚
- 业务操作与日常使用规范

## 3. 系统范围说明
### 3.1 核心功能模块
- 用户账号体系（注册、登录、权限）
- 健康档案（保存、历史）
- 饮食记录（含热量/碳水/糖统计）
- AI 营养师对话（普通/流式）
- 食谱生成中心（生成、导入、保存、导出、反馈闭环）
- 管理端 AI 配置

### 3.2 关键技术栈
- 后端：Spring Boot 3.2、MyBatis Plus、Spring Security、JWT
- 前端：Vue 3、Element Plus、Axios、Vite
- 数据库：MySQL 8.x（推荐）
- AI：兼容 OpenAI 协议接口（当前配置对接阿里云 DashScope 兼容模式）

## 4. 商用上线前硬性要求
## 4.1 安全整改（必须完成）
当前项目存在将密钥与数据库口令写在配置文件的风险，商用前必须整改：
- 禁止在 `backend/src/main/resources/application.yml` 中明文保存 `api-key`、数据库密码。
- 改为环境变量或密钥管理服务（KMS/Secrets Manager）注入。
- 代码仓库历史中若出现过真实密钥，必须立即轮换（作废旧 key，生成新 key）。

建议改造示例（生产环境）：
```yaml
spring:
  ai:
    openai:
      api-key: ${AI_API_KEY}
  datasource:
    url: ${DB_URL}
    username: ${DB_USER}
    password: ${DB_PASSWORD}
```

## 4.2 合规要求（必须评审）
系统涉及健康与饮食相关个人信息，商用前需进行合规评审并形成记录：
- 个人信息最小化收集与用途告知
- 用户授权与隐私政策确认
- 敏感信息访问控制与审计
- 数据导出、删除、账号注销流程
- 跨境与第三方 API 数据传输评估

注意：本系统提供健康管理建议，不构成医疗诊断与处方。

## 4.3 医疗风险提示（必须呈现）
需在产品内明确展示：
- AI 建议仅供参考，不替代医生诊疗
- 关键异常指标（如严重高血糖、极端血压）提示线下就医
- 高风险用户场景优先展示安全提示

## 5. 推荐生产架构（1000 并发级别）
## 5.1 最小可用架构
- `Nginx`：反向代理 + HTTPS + 静态资源
- `Backend x2`：Spring Boot 实例（负载均衡）
- `MySQL x1`：建议主从或高可用托管版
- `Redis x1`：会话、限流、缓存（建议新增）
- `对象存储`：文件导入导出（可选）
- `监控与日志`：Prometheus + Grafana + Loki/ELK（或云监控）

## 5.2 服务器建议（起步）
- Nginx：2C4G
- Backend（每台）：4C8G（2 台）
- MySQL：4C16G，SSD，独立部署
- Redis：2C4G
- 网络：按公网与内网分层，数据库仅开放内网

## 6. 部署目录与配置约定
## 6.1 建议目录
- `/opt/thinkinghelp/backend/` 后端 jar 与配置
- `/opt/thinkinghelp/frontend/` 前端静态文件
- `/opt/thinkinghelp/logs/` 日志目录

## 6.2 配置分层
- `application.yml`：仅保留非敏感默认配置
- `application-prod.yml`：生产参数，不入库敏感值
- 环境变量：密钥与数据库口令

## 7. 数据库初始化与变更
## 7.1 初始化顺序
1. 创建数据库：`thinking_help`
2. 执行基础结构：`backend/src/main/resources/db/schema.sql`
3. 执行补丁脚本：`backend/patch_db.sql`

## 7.2 本次版本重点补丁
必须执行 `patch_db.sql` 中 `Patch 18`，新增食物营养缓存表：
- `food_nutrition_cache`
- 用于“饮食记录自定义食物估算”缓存，减少 AI token 消耗

## 7.3 变更执行规范
- 所有 SQL 在预发布环境先执行并验证
- 生产执行前备份数据库
- 执行后记录版本号、执行人、时间、结果

## 8. 后端部署步骤（生产）
1. 编译打包
```bash
cd backend
mvn clean package -DskipTests
```

2. 启动（示例）
```bash
java -jar target/thinking-help-system-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

3. 进程托管（推荐 `systemd`）
- 保证开机自启
- 限制重启风暴（失败重试策略）

4. 健康检查
- 服务端口：`8080`
- 接口文档：`/doc.html`（生产建议限制访问）

## 9. 前端部署步骤（生产）
1. 构建
```bash
cd frontend
npm install
npm run build
```

2. 发布
- 将 `frontend/dist` 发布到 Nginx 根目录
- 反向代理 `/api` 到后端服务

3. Nginx 要点
- 强制 HTTPS
- 安全响应头
- 静态资源缓存策略
- 请求体大小与超时配置

## 10. 上线验收清单（Go-Live Checklist）
## 10.1 功能验收
- 登录、鉴权、权限校验通过
- 健康档案增删改查通过
- 饮食记录新增/编辑/删除/统计通过
- 自定义食物热量估算：首查 AI、再查缓存链路通过
- AI 对话（流式）可用，自动带入健康档案摘要
- 食谱生成/保存/导出/删除通过

## 10.2 性能验收
- 常用接口 p95 延迟达标
- 错误率在可接受范围
- 高峰并发无明显雪崩

## 10.3 安全验收
- 明文密钥已移除
- HTTPS 生效
- 管理端入口受限
- SQL 注入、XSS、越权基本测试通过

## 11. 商用运行操作手册（SOP）
## 11.1 日常巡检（每日）
- 检查后端可用性与错误日志
- 检查数据库连接数与慢查询
- 检查 AI 调用成功率与费用波动
- 检查任务队列与异步生成是否积压

## 11.2 周期巡检（每周）
- 备份可恢复性抽测
- 权限与账号审计
- 安全补丁与依赖漏洞检查
- 成本报表复盘（AI token、云资源）

## 11.3 用户支持流程
- 一级支持：登录、功能使用问题
- 二级支持：数据异常、导入导出失败
- 三级支持：服务不可用、数据库异常、AI 服务异常

## 12. 监控与告警
## 12.1 必配监控项
- 后端：QPS、错误率、响应时延、JVM 内存、线程池
- 数据库：CPU、连接数、慢查询、磁盘空间
- 前端：白屏率、核心路由加载失败率
- AI：调用次数、失败率、平均耗时、费用

## 12.2 告警分级
- P1：服务不可用、全站登录失败、数据库不可连接
- P2：核心功能不可用（饮食记录/食谱生成）
- P3：非核心异常或局部功能退化

## 13. 备份与灾备
## 13.1 备份策略
- 数据库：每日全量 + 小时增量（或 binlog）
- 备份保留：至少 30 天
- 备份加密：必须

## 13.2 恢复演练
- 每月至少 1 次演练
- 演练内容：按指定时间点恢复 + 业务回归验证

## 14. 安全策略（项目已落地与建议）
## 14.1 已落地
- JWT 鉴权
- 关键操作用户归属校验（如饮食记录/食谱删除）
- 自定义食物估算输入校验
- AI 估算接口限流（按用户每分钟上限）
- 自定义食物估算本地缓存优先（降低 token 消耗）

## 14.2 建议新增（商用强烈推荐）
- Redis 限流替代内存限流（支持多实例）
- Web 应用防火墙（WAF）
- 登录失败次数限制 + 人机验证
- 审计日志落库与检索
- 配置中心与密钥托管

## 15. 版本发布与回滚规范
## 15.1 发布流程
1. 代码冻结
2. 预发布验收
3. 数据库脚本评审
4. 生产变更窗口执行
5. 冒烟验证
6. 放量与观察

## 15.2 回滚策略
- 应用回滚：回滚至上一稳定包
- 数据回滚：按备份/增量日志恢复
- 回滚触发条件：P1/P2 且 15 分钟无法修复

## 16. 商用使用规范（产品侧）
## 16.1 用户端
- 初次使用先完善健康档案
- 饮食记录支持手动输入，系统自动优先本地计算/缓存
- AI 结果显示来源，提示“仅供参考”

## 16.2 运营端
- 关注异常用户指标（极值、持续偏离）
- 管理 AI Key 与模型配置，定期轮换
- 持续优化知识库权威内容

## 17. 已知限制与边界
- 本系统为健康管理辅助，不提供医疗诊断
- AI 估算存在不确定性，需展示来源与风险提示
- 单机内存限流仅适合单实例，集群需迁移到 Redis 等集中式方案

## 18. 上线后首周重点观察
- AI token 消耗曲线是否显著下降（缓存命中效果）
- 饮食估算接口失败率与平均响应时间
- 前端白屏与路由异常
- 用户反馈中的误导性建议风险

## 19. 附录 A：关键文件路径
- 后端配置：`backend/src/main/resources/application.yml`
- 数据库基础脚本：`backend/src/main/resources/db/schema.sql`
- 数据库补丁脚本：`backend/patch_db.sql`
- 饮食估算接口：`backend/src/main/java/com/thinkinghelp/system/controller/DietLogController.java`
- AI 对话接口：`backend/src/main/java/com/thinkinghelp/system/controller/ChatController.java`

## 20. 附录 B：上线前最终口令
以下项目全部勾选后，方可对外开放：
- [ ] 所有密钥已迁移到环境变量/密钥系统
- [ ] 数据库已完成备份与恢复验证
- [ ] `patch_db.sql` 已执行并验证通过
- [ ] 核心功能冒烟测试通过
- [ ] 监控告警已接入并测试
- [ ] 安全与合规评审完成并归档
- [ ] 发布/回滚负责人明确并在岗

## 21. 文档持续追踪要求（强制）
- 每次“大改”完成后，必须同步更新文档，不得仅改代码。
- 文档维护规则以 `read/文档维护规范.md` 为准。
- 变更记录统一写入 `read/项目变更日志.md`，用于发布审计与结题材料沉淀。
- 发布前由负责人检查以下三项：
  - [ ] 任务/路线图已更新
  - [ ] 测试文档与结果已更新
  - [ ] 变更日志已登记
