# 控糖管理测试用例文档

## 0. 追踪信息
- 关联任务编号：`A6`
- 关联变更编号：`TH-2026-02-003`
- 关联任务文档：`read/功能任务清单.md`
- 关联变更文档：`read/项目变更日志.md`

## 1. 目的与范围
用于验证“控糖管理”新增能力是否可用，包含：
- 血糖记录（新增/查询/删除）
- 血糖统计汇总（summary）
- 风险分析与饮食关联（analysis）
- 随访任务（自动生成/完成/删除）
- 首页风险横幅联动

## 2. 测试前准备
1. 后端执行 `backend/patch_db.sql`，确保 `Patch 16`、`Patch 17` 生效。
2. 重启后端服务。
3. 使用普通用户登录（非 ADMIN）。
4. 前端进入 `健康档案 -> 控糖管理`。

## 3. 关键接口清单
- `POST /api/health/glucose-records`
- `GET /api/health/glucose-records`
- `GET /api/health/glucose-records/summary`
- `GET /api/health/glucose-records/analysis`
- `DELETE /api/health/glucose-records/{id}`
- `GET /api/health/glucose-tasks`
- `POST /api/health/glucose-tasks/auto-generate`
- `PUT /api/health/glucose-tasks/{id}/complete`
- `DELETE /api/health/glucose-tasks/{id}`

## 4. 测试数据建议
建议先录入以下血糖记录：
1. 空腹 6.8 mmol/L（正常边缘）
2. 餐后2小时 11.6 mmol/L（偏高）
3. 餐后2小时 12.3 mmol/L（偏高）
4. 睡前 3.6 mmol/L（偏低）
并在饮食记录页添加对应餐次（含高碳水餐）。

## 5. 测试用例

### A. 页面与基础流程
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| GLU-001 | 控糖页签可见 | 打开健康档案页面 | 可看到“控糖管理”Tab |
| GLU-002 | 表单默认值 | 进入控糖页签 | 血糖类型默认“空腹”，时间为当前 |
| GLU-003 | 必填校验-血糖值 | 不填血糖值直接保存 | 前端提示“请输入有效血糖值” |
| GLU-004 | 新增记录成功 | 填写完整后保存 | 提示成功，记录出现在历史表格 |
| GLU-005 | 删除记录成功 | 删除一条记录 | 提示成功，列表移除 |

### B. 血糖记录接口
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| GLU-101 | 新增-合法数据 | 调 `POST /glucose-records` | `code=200`，DB 新增 |
| GLU-102 | 新增-缺少 userId | body 不传 userId | 返回错误“缺少用户ID” |
| GLU-103 | 新增-血糖<=0 | glucoseValue=0 | 返回错误“请输入有效血糖值” |
| GLU-104 | 查询-按时间范围 | 调 `GET /glucose-records?start&end` | 仅返回区间内数据 |
| GLU-105 | 查询-按类型 | `measureType=POST_MEAL_2H` | 仅返回该类型 |

### C. 汇总与风险分析
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| GLU-201 | summary 统计正确 | 调 `GET /summary` | 返回 avg/高低次数/总数，数值合理 |
| GLU-202 | analysis 空数据 | 清空血糖记录后调 `GET /analysis` | riskLevel=LOW，alerts 提示“先连续记录” |
| GLU-203 | analysis 风险分级 | 有多条高血糖记录 | riskLevel 变为 MEDIUM/HIGH |
| GLU-204 | analysis 餐后关联 | 有餐后2h高血糖+对应饮食记录 | mealImpacts 有匹配餐次与建议 |
| GLU-205 | analysis 无餐次匹配 | 餐后高血糖但无饮食记录 | 提示“未匹配到饮食记录” |

### D. 随访任务
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| GLU-301 | 自动生成任务 | 点击“自动生成任务” | 根据规则生成 0~N 条任务 |
| GLU-302 | 防重复生成 | 连续多次点击自动生成 | 同类型 PENDING 任务不重复堆积 |
| GLU-303 | 完成任务 | 点击任务“完成” | 状态变 DONE，完成时间写入 |
| GLU-304 | 删除任务 | 点击“删除” | 任务移除 |
| GLU-305 | 任务筛选 | 调 `GET /glucose-tasks?status=PENDING` | 仅返回待完成任务 |

### E. 首页联动
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| GLU-401 | 风险横幅显示 | 产生 MEDIUM/HIGH 风险 | 首页出现风险横幅 |
| GLU-402 | 待办数量显示 | 存在 PENDING 任务 | 横幅显示待处理任务数量 |
| GLU-403 | 低风险无待办 | risk=LOW 且待办=0 | 横幅不显示 |

### F. 回归与异常
| 编号 | 用例 | 步骤 | 预期结果 |
|---|---|---|---|
| GLU-501 | 不影响原数据记录页 | 进入“数据记录”Tab | 原功能正常可用 |
| GLU-502 | 不影响历史档案页 | 进入“档案历史”Tab | 原功能正常可用 |
| GLU-503 | 异常接口容错 | 人为停后端再访问控糖页 | 页面不白屏，出现错误提示 |
| GLU-504 | 时间筛选边界 | 开始=结束当天 | 查询结果符合当天时间边界 |

## 6. 冒烟测试最小路径（建议每次发布后执行）
1. 新增 1 条空腹血糖记录。
2. 新增 1 条餐后2小时高血糖记录。
3. 查看 summary 与 analysis。
4. 点击“自动生成任务”，完成 1 条任务。
5. 返回首页确认风险横幅和待办数联动。

## 7. 结果记录模板
可按如下格式记录：
- 用例编号：GLU-xxx
- 执行时间：
- 实际结果：
- 是否通过：Pass/Fail
- 备注（日志/截图/接口返回）：
